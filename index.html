<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Convert WhatsApp to Signal</title>

    <!-- jQuery 3.5.1 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.slim.min.js"
        integrity="sha512-/DXTXr6nQodMUiq+IUJYCt2PPOUjrHJ9wFrqpJ3XkgPNOZVfMok7cRw6CSxyCQxXn6ozlESsSh1/sMCTF1rL/g=="
        crossorigin="anonymous"></script>

    <!-- Bootstrap 4.3.1 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/css/bootstrap.min.css"
        integrity="sha512-oc9+XSs1H243/FRN9Rw62Fn8EtxjEYWHXRvjS43YtueEewbS6ObfXcJNyohjHqVKFPoXXUxwc+q1K7Dee6vv9g=="
        crossorigin="anonymous" />
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.6.0/umd/popper.min.js"
        integrity="sha512-BmM0/BQlqh02wuK5Gz9yrbe7VyIVwOzD1o40yi1IsTjriX/NGF37NyXHfmFzIlMmoSIBXgqDiG1VNU6kB5dBbA=="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/js/bootstrap.min.js"
        integrity="sha512-8qmis31OQi6hIRgvkht0s6mCOittjMa9GMqtK9hes5iEQBQE/Ca6yGE5FsW36vyipGoWQswBj/QBm2JR086Rkw=="
        crossorigin="anonymous"></script>
    </script>

    <!-- Font Awesome 5.15.1 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/solid.min.css"
        integrity="sha512-SazV6tF6Ko4GxhyIZpKoXiKYndqzh7+cqxl9HDH7DGSpjkCN3QLqTAlhJHJnKxu3/2rfCsltzwFC4CmxZE1hPg=="
        crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/js/solid.min.js"
        integrity="sha512-JkeOaPqiSsfvmKzJUsqu7j2fv0KSB6Yqb1HHF0r9FNzIsfGv+zYi4h4jQKOogf10qLF3PMZEIYhziCEaw039tQ=="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/js/fontawesome.min.js"
        integrity="sha512-kI12xOdWTh/nL2vIx5Yf3z/kJSmY+nvdTXP2ARhepM/YGcmo/lmRGRttI3Da8FXLDw0Y9hRAyZ5JFO3NrCvvXA=="
        crossorigin="anonymous"></script>

    <!-- Vue.js 2.6.12 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.12/vue.min.js"
        integrity="sha512-BKbSR+cfyxLdMAsE0naLReFSLg8/pjbgfxHh/k/kUC82Hy7r6HtR5hLhobaln2gcTvzkyyehrdREdjpsQwy2Jw=="
        crossorigin="anonymous"></script>

    <!-- highlight.js 10.5.0 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/a11y-dark.min.css"
        integrity="sha512-1rzCaYWsg3l6uKvGbUT6rAZFOcVn0zeXAFlZudsnj8k2xcrU5asL8jfJUEijV9GPYMh0GnPToeCTJj6RXQnA8g=="
        crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"
        integrity="sha512-9GIHU4rPKUMvNOHFOer5Zm2zHnZOjayOO3lZpokhhCtgt8FNlNiW/bb7kl0R5ZXfCDVPcQ8S4oBdNs92p5Nm2w=="
        crossorigin="anonymous"></script>

    <style>
        #xml-code pre {
            max-height: 300px;
            padding-bottom: 10px;
            overflow: auto;
        }

        span.key {
            padding: 5px 10px;
            font-weight: bold;
            background: #ccc;
            min-width: 30px;
            display: inline-block;
            text-align: center;
            border-radius: 10px;
            margin-top: 5px;
        }

        i.fa-custom-next {
            margin: 0 5px;
        }

        b {
            white-space: nowrap;
        }

        span#owner {
            font-size: 1rem;
            margin-bottom: .5rem;
            font-weight: 500;
            line-height: 1.2;
        }
    </style>
</head>

<body>
    <div class="container my-3" id="app">
        <h4>
            js-convert-whatsapp-to-signal
            <span id="owner">by <a href="https://github.com/DemChing">Dem Ching</a></span>
        </h4>
        <div class="row mt-3">
            <div class="col">
                <div class="form-group">
                    <div class="alert alert-primary">
                        This is an alternative for people without Python to import
                        <whatsapp></whatsapp> conversations to <signal></signal>.
                        <br><br>
                        It's based on the Github project
                        <a href="https://github.com/gillesvangestel/ConvertWhatsAppToSignal">ConvertWhatsAppToSignal</a>
                        by <a href="https://github.com/gillesvangestel">gillesvangestel</a>.
                        <br>
                        For original instructions, please check <a href="https://bit.ly/3idxDwc">here</a>.
                    </div>
                    <div class="alert alert-danger">
                        This only works for <b>Android</b> devices.
                        <br>
                        Only <b>TEXT</b> messages can be imported to
                        <signal></signal>.
                        Media messages like video, audio and sticker are not supported.
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div class="form-group">
                    <label>
                        <h4>Instruction</h4>
                    </label>
                    <div class="list-group">
                        <a href="#phase-1" data-toggle="collapse" role="button" aria-expanded="false"
                            class="list-group-item list-group-item-action">
                            Phase 1. Export conversations from <whatsapp></whatsapp>
                        </a>
                        <ul class="list-group collapse" id="phase-1">
                            <li class="list-group-item">
                                1. Enter a <whatsapp></whatsapp> chat.
                            </li>
                            <li class="list-group-item">2. At the top right corner, click
                                <span class="key"><i class="fas fa-ellipsis-v"></i></span>
                                <i class="fa-custom-next"></i>
                                <span class="key">More</span>
                                <i class="fa-custom-next"></i>
                                <span class="key">Export chat</span>
                                <i class="fa-custom-next"></i>
                                <span class="key">Without Media</span>.
                            </li>
                            <li class="list-group-item">
                                3. Save the exported <b>.txt</b>
                                file in the way you like. e.g. Dropbox, Google Drive.
                            </li>
                            <li class="list-group-item">
                                4. Rename exported chats to this format:
                                <b>[Contact Number]-[Contact Name].txt</b>
                                <br><br>
                                <b>Contact Number</b> and <b>Contact Name</b> must be the same as in your contacts.
                                <br><br>
                                e.g.
                                <span class="key">+12398765432-Test Name.txt</span>
                                <span class="key">98765432-Test Name.txt</span>
                                <br><br>
                                You may also check if the <b>Contact Name</b> is the same as in the exported chat.
                                You should find lines like that:
                                <br>
                                2021/1/13 16:52 - <b>Test Name</b>: Test messages<br>
                                2021/1/13 19:11 - My Name: My messages<br>
                                2021/1/13 19:13 - <b>Test Name</b>: Test messages<br>
                            </li>
                            <li class="list-group-item">5. Repeat
                                <b>Step 1 - 4</b>
                                until you export all desired chats.
                            </li>
                            <li class="list-group-item list-group-item-primary">Or you can start with <b>Step 2</b>
                                without entering a chat and choose the chat after you click
                                <span class="key">Export chat</span>.
                            </li>
                        </ul>
                        <a href="#phase-2" data-toggle="collapse" role="button" aria-expanded="false"
                            class="list-group-item list-group-item-action">
                            Phase 2. Export SMS restoration file on this page
                        </a>
                        <ul class="list-group collapse" id="phase-2">
                            <li class="list-group-item">
                                1. Open one of the <b>.txt</b> file and check if the date format is right.
                                <br><br>
                                <b>Y</b> for year, <b>M</b> for month, <b>D</b> for date.
                                <br><br>
                                e.g. <b>2021/1/13 16:52</b> should be <b>Y/M/D</b>.
                            </li>
                            <li class="list-group-item">2. Upload all the <b>.txt</b> files here.</li>
                            <li class="list-group-item">
                                3. Click <span class="key">Export</span> to download a <b>.xml</b> file.
                                <br><br>
                                It should be named as <b>sms-[Random String].xml</b>.
                            </li>
                            <li class="list-group-item">
                                4. Save the exported <b>.xml</b>
                                file in the way you like. e.g. Dropbox, Google Drive.
                            <li class="list-group-item list-group-item-primary">
                                All the files are processed locally and <b>DO NOT</b> send to any third party.
                                As long as your device is safe, your conversations are kept secret.
                            </li>
                        </ul>
                        <a href="#phase-3" data-toggle="collapse" role="button" aria-expanded="false"
                            class="list-group-item list-group-item-action">
                            Phase 3. Backup and erase your SMS messages
                            <b> (NOT <whatsapp></whatsapp>)</b>
                        </a>
                        <ul class="list-group collapse" id="phase-3">
                            <li class="list-group-item">
                                1. Install <a href="https://bit.ly/3bOKmUX">
                                    <smsbr></smsbr>
                                </a> in Google Play Store if you didn't install before.
                            </li>
                            <li class="list-group-item">2. At the top left corner, click
                                <span class="key"><i class="fas fa-bars"></i></span>
                                <i class="fa-custom-next"></i>
                                <span class="key">Back up now</span>
                                <i class="fa-custom-next"></i>
                                Follow the in-app steps to backup
                                <i class="fa-custom-next"></i>
                                Save the exported <b>.xml</b>
                                file in the way you like. e.g. Dropbox, Google Drive.
                            </li>
                            <li class="list-group-item">3. Wait until the backup complete.</li>
                            <li class="list-group-item">4. Erase all you SMS messages.</li>
                            <li class="list-group-item list-group-item-primary">
                                You can choose not to backup <b>Phone calls</b> to speed up the process.
                                You can also choose not to schedule a regularly backup.
                                <br><br>
                                In backup setting, remember to select
                                <span class="key">All messages</span> instead of
                                <span class="key">Selected conversations only</span>
                                as you're going to <b>ERASE ALL</b> SMS.
                            </li>
                            <li class="list-group-item">5. At the top left corner, click
                                <span class="key"><i class="fas fa-bars"></i></span>
                                <i class="fa-custom-next"></i>
                                <span class="key">Restore</span>
                                <i class="fa-custom-next"></i>
                                Choose the <b>.xml</b> file generated in <b>Phase 2</b> to restore.
                            </li>
                            <li class="list-group-item">
                                6. Wait until the restoration complete.
                                <br>
                                Your system SMS messages should contain the <whatsapp></whatsapp> chats.
                            </li>
                            <li class="list-group-item list-group-item-primary">
                                SMS restoration may require extra permission and setting.
                                Follow the in-app instructions and everything will be fine.
                            </li>
                        </ul>
                        <a href="#phase-4" data-toggle="collapse" role="button" aria-expanded="false"
                            class="list-group-item list-group-item-action">
                            Phase 4. Import SMS messages to <signal></signal>
                        </a>
                        <ul class="list-group collapse" id="phase-4">
                            <li class="list-group-item">
                                1. Install <a href="https://bit.ly/39swZXz">
                                    <signal></signal>
                                </a> in Google Play Store if you didn't install before.
                            </li>
                            <li class="list-group-item">2. At the top right corner, click
                                <span class="key"><i class="fas fa-ellipsis-v"></i></span>
                                <i class="fa-custom-next"></i>
                                <span class="key">Setting</span>
                                <i class="fa-custom-next"></i>
                                <span class="key">SMS and MMS</span>
                                <i class="fa-custom-next"></i>
                                Enable SMS
                            </li>
                            <li class="list-group-item list-group-item-primary">
                                You may need to reinstall <signal></signal> for this to work.
                                Remember to backup your chats first.
                                <br><br>
                                You can disable SMS if you don't need it after the import.
                            </li>
                        </ul>
                        <a href="#phase-5" data-toggle="collapse" role="button" aria-expanded="false"
                            class="list-group-item list-group-item-action">
                            Phase 5. Restore system SMS
                        </a>
                        <ul class="list-group collapse" id="phase-5">
                            <li class="list-group-item">1. Erase all you SMS messages.</li>
                            <li class="list-group-item">2. Go to
                                <smsbr></smsbr>.</li>
                            <li class="list-group-item">3. At the top left corner, click
                                <span class="key"><i class="fas fa-bars"></i></span>
                                <i class="fa-custom-next"></i>
                                <span class="key">Restore</span>
                                <i class="fa-custom-next"></i>
                                Choose the <b>.xml</b> file generated in <b>Phase 3</b> to restore.
                            </li>
                            <li class="list-group-item">
                                4. Wait until the restoration complete.
                                <br>
                                Your system SMS messages should contain the original SMS messages.
                            </li>
                            <li class="list-group-item list-group-item-primary">
                                Be careful to choose the correct <b>.xml</b> file in <b>Phase 3</b>.
                                <br><br>
                                If you restore a wrong file, repeat steps in this Phase and choose the right file.
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div class="form-group">
                    <label for="file">
                        <h4>Date Format</h4>
                    </label>
                    <div class="alert alert-info">
                        <b>Y</b> for year, <b>M</b> for month, <b>D</b> for date
                    </div>
                    <input type="text" aria-label="Date Format" class="form-control" placeholder="Date Format"
                        v-model="dateFormat">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div class="form-group">
                    <label for="file">
                        <h4>Files</h4>
                    </label>
                    <div class="alert alert-info"> Remember to rename exported chats </div>
                    <div class="custom-file">
                        <input type="file" class="custom-file-input" id="file" aria-describedby="file" multiple
                            accept="text/plain" @change="fileChange">
                        <label class="custom-file-label" for="file">Choose file</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" v-if="Object.keys(contacts).length">
            <div class="col">
                <label>
                    <h4>Contacts</h4>
                </label>
            </div>
        </div>
        <div class="row mt-1" v-for="(contact, id) in contacts"
            :set="hasError = contact.lines == 0 || contact.smses.length == 0">
            <div class="col">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span v-if="hasError" key="input-error" class="input-group-text bg-danger text-white"
                            :title="contact.lines == 0 ? 'Empty file' : 'Date format not matched'">
                            <i class="fas fa-exclamation"></i>
                        </span>
                        <span v-if="!hasError && contact.skipped > 0" key="input-warning"
                            class="input-group-text bg-warning text-white" title="Skipped Lines">
                            {{contact.skipped}}
                        </span>
                        <span v-if="!hasError && contact.smses.length > 0" key="input-success"
                            class="input-group-text bg-success text-white" title="Processed Messages">
                            {{contact.smses.length}}
                        </span>
                    </div>
                    <input type="text" aria-label="Phone Number" class="form-control" placeholder="Phone Number"
                        v-model="contact.phone" readonly>
                    <input type="text" aria-label="Contact Name" class="form-control" placeholder="Contact Name"
                        v-model="contact.name" readonly>
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-danger" title="Remove Contact"
                            @click="removeContacts(id)">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3" v-if="xml">
            <div class="col" id="xml-code">
                <label>Preview</label>
                <highlightjs language="html" :code="beautifier()" />
            </div>
        </div>
        <div class="row" v-if="xml">
            <div class="col">
                <div class="form-group">
                    <button type="button" class="btn btn-primary" @click="exportFile()">Export</button>
                </div>
            </div>
        </div>
        <div class="modal fade" role="dialog" aria-hidden="true" id="modal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Warning</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        The following files are not processed:
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item" v-for="name in ignored">{{name}}</li>
                        </ul>
                        <p class="mt-3">Please check the format of the filename.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    function replaceApp() {
        let selectors = {
            'smsbr': {
                name: 'SMS Backup & Restore',
                class: 'info'
            },
            'signal': {
                name: 'Signal',
                class: 'primary'
            },
            'whatsapp': {
                name: 'WhatsApp',
                class: 'success'
            },
        }
        for (let key in selectors) {
            $(key).html(
                `<span class="text-${selectors[key].class} font-weight-bold">${selectors[key].name}</span>`
            );
        }
    }
    Vue.use(hljs.vuePlugin);
    $('i.fa-custom-next').html(`<i class="fas fa-chevron-right"></i>`);
    replaceApp();
    let app = new Vue({
        el: '#app',
        data: {
            contacts: {},
            dateFormat: 'Y/M/D',
            uuid: '',
            xml: '',
            preview: '',
            ignored: [],
        },
        methods: {
            numberFormat(from, to = 0) {
                return `(\\d{${from}${to > 0 ? `,${to}` : ''}})`
            },
            createUUID() {
                let delta = Date.now();
                if (window.performance && window.performance.now) delta = window.performance.now();
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    let r = ((Math.random() * 16 + delta) | 0) % 16,
                        v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            },
            parse(text, receiver) {
                let dateString = this.dateFormat
                    .replace('Y', this.numberFormat(4))
                    .replace('M', this.numberFormat(1, 2))
                    .replace('D', this.numberFormat(1, 2)),
                    dateRegExp = new RegExp(`^${dateString}`),
                    lineRegExp = new RegExp(
                        `^${dateString} ${this.numberFormat(1, 2)}:${this.numberFormat(1, 2)} - (.+): (.+)$`
                    ),
                    prev, split = text.trim().split(/\r?\n/),
                    smses = [],
                    skipped = 0;
                for (let i = 0; i < split.length; i++) {
                    let match = split[i].match(lineRegExp);
                    if (match) {
                        if (prev)
                            smses.push(prev);
                        prev = {
                            type: receiver.name == match[6] ? 1 : 2,
                            date: new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(
                                    match[3]),
                                parseInt(match[
                                    4]), parseInt(match[5])),
                            body: match[7],
                        };
                    } else if (!dateRegExp.test(split[i]) && prev) {
                        prev.body += `\n${split[i]}`;
                    } else {
                        if (prev)
                            smses.push(prev);
                        skipped++;
                        prev = false;
                    }
                }
                if (prev)
                    smses.push(prev);

                return {
                    ...receiver,
                    skipped,
                    smses,
                    lines: split.length,
                };
            },
            createXml() {
                let count = 0,
                    body = '',
                    preview = '';
                for (let key in this.contacts) {
                    this.contacts[key].smses.map((sms, i) => {
                        let line =
                            `<sms address="${this.contacts[key].phone}" date="${sms.date.getTime()}" read="1" status="-1" type="${sms.type}" body="${sms.body}" />`;
                        body += line;
                        preview += i < 3 ? line : i == 4 ? '<sms  ...   />' : '';
                    })
                    count += this.contacts[key].smses.length;
                }
                if (count > 0) {
                    let build = (str) =>
                        `<?xml version="1.0" ?><smses count="${count}" backup_set="${this.uuid}" backup_date="${Date.now()}" type="full">${str}</smses>`
                    this.uuid = this.createUUID();
                    this.xml = build(body);
                    this.preview = build(preview);
                } else {
                    this.xml = '';
                }
            },
            beautifier() {
                return this.preview.replace(/<(\/)?sms(es)?/g, (m, m1, m2) => {
                    if (m2) return `\n${m}`
                    if (!m1 && !m2) return `\n    ${m}`
                    return m;
                })
            },
            exportFile() {
                let link = document.createElement('a'),
                    blob = new Blob([this.xml], {
                        type: 'text/xml'
                    });
                link.href = window.URL.createObjectURL(blob);
                link.download = `sms-${this.uuid}.xml`;
                link.click();
            },
            fileChange(e) {
                let _this = this,
                    ignored = [];
                [...e.target.files].forEach(file => {
                    let match = file.name.match(/([0-9+-]+)-(.+).te?xt/);
                    if (match) {
                        let contact = {
                                phone: match[1],
                                name: match[2],
                            },
                            fr = new FileReader();
                        fr.onload = function () {
                            _this.$set(_this.contacts, `${contact.phone}-${contact.name}`, {
                                ...contact,
                                ..._this.parse(fr.result, contact),
                            });
                            _this.createXml()
                        }
                        fr.readAsText(file);
                    } else {
                        ignored.push(file.name);
                    }
                })
                if (ignored.length) {
                    this.ignored = ignored;
                    $('#modal').modal('show');
                }
                e.target.value = null;

            },
            removeContacts(id) {
                this.$delete(this.contacts, id)
                this.createXml()
            },
        }
    })
</script>